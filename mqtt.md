# MQTT

## 消息格式

固定报文头|可变报文头|负荷



## 固定报文头

- 最少两个字节
  - 第一字节包含消息类型 和 QoS级别等标志位
  - 第二字节开始是剩余长度字段, 也就是计算 剩下的 可变报文头 + 负荷总共有多少长度(最多允许4个字节)
- 能发送的最大消息长度是 256mb

## 可变报文头

包括协议名，协议版本，连接标志，心跳间隔时间，连接返回码，主题名等(跟通信有关的信息)

## 服务质量QoS

- QoS 0, 尽力而为: 会想办法发送消息，但是遇到意外不会重试 <=1, 最多一次，发完即丢弃
- QoS 1, 至少一次: 确保消息到达，但是可能会重复发送消息 >=1, 至少一次，需要确认回复
- QoS 2, 只有一次: 确保消息到达一次 =1。小型传输，开销很小，只有一次，需要确认回复

## 消息类型

| 消息名      | 消息值 | 传递方向 | 描述                                       |
| ----------- | ------ | -------- | ------------------------------------------ |
| Reserved    | 0      | -        | 保留                                       |
| CONNECT     | 1      | c  => s  | 客户端请求连接服务端                       |
| CONNACK     | 2      | s  =>  c | 同意连接                                   |
| PUBLISH     | 3      | c <=> s  | 推送消息                                   |
| PUBACK      | 4      | c <=> s  | 推送同意的消息 QoS =1 时，用于确认消息收到 |
| PUBREC      | 5      | c <= s   | QoS =2时, 表示已释放                       |
| PUBREL      | 6      | c <=> s  | QoS =2时, 表示已完成                       |
| PUBCOMP     | 7      | c <=> s  |                                            |
| SUBSCRIBE   | 8      | c => s   | 客户端订阅主题                             |
| SUBACK      | 9      | s =>  c  | 服务端同意客户端订阅主题                   |
| UNSUBSCRIBE | 10     | c => s   | 取消订阅主题                               |
| UNSUBACK    | 11     | s => c   | 服务端同意客户端取消订阅                   |
| PINGREQ     | 12     | c => s   | ping请求                                   |
| PINGRESP    | 13     | s => c   | ping响应                                   |
| DISCONNECT  | 14     | c => s   | 客户端请求断开                             |
| Reserved    | 15     | -        | 保留                                       |

## DUP flag(打开标志)

保证消息可靠传输，默认为0。只占用一个字节，表示第一次发送。

只适用于客户端或服务器端尝试重发PUBLISH, PUBREL, SUBSCRIBE 或 UNSUBSCRIBE 消息

- 当 QoS > 0时，消息需要回复
- 当值为1时，表示当前消息事先已经被传送过.

，满足上面两个条件是才使用



## RETAIN(保持)

仅针对PUBLISH消息。

- 1 ：表示发送的消息需要一直持久保存(不受服务器重启影响), 不但要发送给当前的订阅者，并且以后新来的订阅了此Topic 的订阅者也会马上得到推送(只会推送一个最新的RETAIN flag = 1的消息)
- 仅仅为当前订阅者推送此消息